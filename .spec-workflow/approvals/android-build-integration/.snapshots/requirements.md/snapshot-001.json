{
  "id": "snapshot_1763017235979_j8f1ioa2a",
  "approvalId": "approval_1763017235976_b3aso8cqj",
  "approvalTitle": "Android Build Integration - Requirements",
  "version": 1,
  "timestamp": "2025-11-13T07:00:35.979Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document: Android Build Integration\n\n## Introduction\n\nThe beatbox trainer application currently fails to build and run on Android devices due to missing native library integration. The Rust audio engine compiles successfully for desktop targets but encounters Android-specific compilation errors when cross-compiling for ARM/ARM64 architectures. This prevents the app from launching on physical Android devices, blocking all on-device testing and user deployment.\n\nThis feature will establish complete Android build infrastructure, fixing all platform-specific compilation errors, integrating cargo-ndk for cross-compilation, and ensuring the Rust native library (libbeatbox_trainer.so) is correctly packaged into the APK and loaded at runtime.\n\n## Alignment with Product Vision\n\nFrom **product.md**:\n- **Core principle**: \"Uncompromising Real-Time Performance\" - requires native Rust/C++ audio engine to run on Android hardware\n- **Target platform**: Android devices (primary deployment target)\n- **Success metric**: < 20ms end-to-end audio latency - impossible without native Android build\n\nFrom **tech.md**:\n- **Native-First Architecture**: 4-layer stack (C++ Oboe → Rust → Java/JNI → Dart/Flutter) is core to the architecture\n- **Critical requirement**: \"Manual JNI_OnLoad Implementation\" already identified as necessary for Flutter+Oboe integration\n- **Deployment target**: Android 7.0+ (API 24+), ARM64-v8a and armeabi-v7a architectures\n\n**Blocking Issue**: Without Android build capability, the entire native-first architecture cannot be validated on real hardware, and no user can run the application.\n\n## Requirements\n\n### Requirement 1: Fix Oboe Audio Callback Compilation\n\n**User Story:** As a developer, I want the Rust audio engine to compile for Android targets, so that I can build the APK with the native audio library included.\n\n#### Acceptance Criteria\n\n1. WHEN compiling `rust/src/audio/engine.rs` for `aarch64-linux-android` target THEN the compiler SHALL successfully compile the oboe audio callback closure\n2. WHEN the audio callback is defined THEN it SHALL satisfy the `AudioOutputCallback` trait bounds required by oboe-rs v0.6.x\n3. WHEN cross-compiling for all Android architectures (arm64-v8a, armeabi-v7a, x86_64) THEN all builds SHALL complete without trait bound errors\n\n### Requirement 2: Fix ndk-context Initialization\n\n**User Story:** As a developer, I want the Android context to initialize correctly, so that oboe can access the Android AudioManager.\n\n#### Acceptance Criteria\n\n1. WHEN `JNI_OnLoad` is called during library loading THEN `ndk_context::initialize_android_context()` SHALL be called with both required parameters (JavaVM pointer and Context jobject)\n2. WHEN the app starts on Android THEN the system SHALL NOT crash with \"android context was not initialized\" error\n3. IF `MainActivity.kt` loads the native library THEN it SHALL provide the application context to the Rust JNI layer\n\n### Requirement 3: Configure cargo-ndk Build Integration\n\n**User Story:** As a developer, I want cargo-ndk to automatically build the Rust library during `flutter build apk`, so that the native library is always up-to-date in the APK.\n\n#### Acceptance Criteria\n\n1. WHEN running `flutter build apk` THEN the build system SHALL invoke `cargo ndk` to cross-compile the Rust library for all target architectures\n2. WHEN cargo-ndk completes THEN the compiled `.so` files SHALL be placed in `android/app/src/main/jniLibs/{arch}/libbeatbox_trainer.so`\n3. IF the Rust source code changes THEN subsequent Flutter builds SHALL detect the change and recompile the Rust library\n\n### Requirement 4: Package Native Library in APK\n\n**User Story:** As a user, I want the app APK to contain the native audio library, so that the app can run on my Android device.\n\n#### Acceptance Criteria\n\n1. WHEN the APK is built THEN it SHALL contain `lib/{arch}/libbeatbox_trainer.so` for all supported architectures (arm64-v8a, armeabi-v7a, x86_64)\n2. WHEN listing APK contents with `unzip -l app-debug.apk` THEN the native library SHALL be present alongside libflutter.so\n3. IF a user installs the APK on an ARM64 device THEN the Android package manager SHALL extract and load the arm64-v8a version of the library\n\n### Requirement 5: Load Native Library at Runtime\n\n**User Story:** As a user, I want the app to start successfully, so that I can use the beatbox trainer.\n\n#### Acceptance Criteria\n\n1. WHEN the app launches THEN `MainActivity.kt` SHALL successfully call `System.loadLibrary(\"beatbox_trainer\")`\n2. WHEN the native library is loaded THEN the `JNI_OnLoad` function SHALL execute and initialize the Android context\n3. IF the library fails to load THEN the app SHALL display a user-friendly error message (NOT crash with UnsatisfiedLinkError)\n\n### Requirement 6: Verify End-to-End Android Execution\n\n**User Story:** As a developer, I want to verify the app runs on a physical Android device, so that I can confirm the native audio engine works correctly.\n\n#### Acceptance Criteria\n\n1. WHEN running `flutter run -d <device-id>` THEN the app SHALL build, install, and launch successfully on a connected Android device\n2. WHEN the app UI loads THEN the user SHALL be able to tap the \"Start\" button without crashes\n3. WHEN the audio engine starts THEN the Rust `start_audio()` function SHALL execute without errors and begin the real-time audio callback loop\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n\n- **Build System Separation**: Android build configuration (Gradle, CMake integration) SHALL be isolated in `android/` directory\n- **Platform Abstraction**: Rust code SHALL use conditional compilation (`#[cfg(target_os = \"android\")]`) for Android-specific initialization, keeping cross-platform code clean\n- **Error Propagation**: Android-specific errors (JNI failures, library loading errors) SHALL propagate through the error handling system defined in `rust/src/error.rs`\n- **Documentation**: All Android-specific initialization code SHALL include comments explaining the JNI/NDK context requirements\n\n### Performance\n\n- **Build Time**: Full clean build (Rust cross-compilation + Flutter build) SHALL complete in < 5 minutes on a development machine with 16GB RAM\n- **Incremental Build**: Rust-only changes SHALL rebuild in < 30 seconds using cargo-ndk's incremental compilation\n- **APK Size**: Adding the Rust native library SHALL increase APK size by < 15MB (typical compressed .so size for 3 architectures)\n- **Audio Latency**: No regression - Android audio latency SHALL remain < 20ms as specified in tech.md\n\n### Security\n\n- **Library Verification**: The build system SHALL verify the integrity of the compiled .so files before packaging (checksum validation)\n- **Permission Handling**: Microphone permission SHALL be requested at runtime before accessing audio hardware (existing requirement, not changed)\n- **No Data Leakage**: JNI initialization SHALL NOT log sensitive information (device identifiers, user data) to logcat\n\n### Reliability\n\n- **Graceful Degradation**: IF the native library fails to load THEN the app SHALL display an error dialog with troubleshooting steps (e.g., \"Device not supported - requires Android 7.0+\")\n- **Architecture Detection**: The APK SHALL contain libraries for all supported architectures, and Android SHALL automatically select the correct version for the device\n- **Build Reproducibility**: Given the same source code and toolchain versions, the build SHALL produce bit-identical .so files (deterministic builds)\n\n### Usability\n\n- **Developer Experience**: Developers SHALL be able to build the APK with a single command: `flutter build apk`\n- **Error Messages**: Compilation errors SHALL clearly indicate which Android-specific issue occurred (e.g., \"oboe callback trait mismatch\" vs \"ndk-context initialization missing parameter\")\n- **CI/CD Integration**: The build system SHALL be compatible with GitHub Actions or similar CI systems for automated Android builds\n",
  "fileStats": {
    "size": 7976,
    "lines": 118,
    "lastModified": "2025-11-13T07:00:24.206Z"
  },
  "comments": []
}