# Task 9.2 – Sandbox Attempt #2 (Local Flutter + Build Runner)

**Timestamp:** 2025-11-17T00:36:00Z  
**Engineer:** Codex QA (CLI session)  
**Objective:** Push the Codex CLI as far as possible for UAT execution by installing a writable Flutter SDK inside the repository, regenerating generated Dart assets, and rerunning the integration harness.

---

## Actions
1. **Local Flutter toolchain**
   - Mirrored `/home/rmondo/flutter` into `.flutter-sdk/` inside the repo and created workspace-local `HOME`, `PUB_CACHE`, and `GRADLE_USER_HOME` folders.
   - Exported env vars for every Flutter/Dart command:  
     `FLUTTER_ROOT=$PWD/.flutter-sdk`, `PATH=$FLUTTER_ROOT/bin:$PATH`, `HOME=$PWD/.home`, `PUB_CACHE=$PWD/.pub-cache`, `GRADLE_USER_HOME=$PWD/.gradle`, `FLUTTER_SKIP_UPDATE_CHECK=true`, `FLUTTER_SUPPRESS_ANALYTICS=true`, `DART_SUPPRESS_ANALYTICS=true`.
   - Copied cached pub packages from `/home/rmondo/.pub-cache` to keep the toolchain offline.
2. **Regenerated Freezed outputs**
   - Ran `dart run build_runner build --delete-conflicting-outputs` with the overrides above.
   - ✅ `lib/bridge/api.dart/error.freezed.dart` now includes the `AudioError_StreamFailure` and `CalibrationError_Timeout` constructors so Dart analysis errors disappear.
3. **Tried flutter_rust_bridge codegen**
   - Executed `flutter_rust_bridge_codegen generate` (with `RUSTUP_HOME=/home/rmondo/.rustup`, `CARGO_HOME=/home/rmondo/.cargo`, `CARGO_NET_OFFLINE=true`).
   - ❌ `cargo expand` cannot download the missing `axum-macros` crate while offline, so bridge regeneration must happen on a workstation with internet access.
4. **Integration harness**
   - Re-ran `flutter test --no-pub test/integration/calibration_flow_test.dart`.
   - ❌ Tests now fail because the sandbox cannot open a VM server socket: `Failed to create server socket (OS Error: Operation not permitted, errno = 1), address = 127.0.0.1, port = 0`. This confirms the Dart analyzer is clean but the CLI cannot simulate device interactions.

---

## Outcome
- ✅ Freezed/Freezed-generated constructors restored so Dart compilation is unblocked.
- ✅ Documented the exact environment overrides required to run Flutter/Dart completely inside the repo.
- ❌ flutter_rust_bridge codegen still blocked offline (requires `axum-macros` download), so the generated FFI glue must be refreshed outside the sandbox.
- ❌ Integration/UAT flows remain blocked because the sandbox denies socket creation, APK builds still fail (`Could not determine a usable wildcard IP`), and `adb` daemon startup continues to be forbidden.
- ✍ Updated `UAT_TEST_SCENARIOS.md`, `.spec-workflow/.../UAT_TEST_SCENARIOS.md`, and `tasks.md` with the new findings plus a Scenario Execution Tracker for on-device QA.

---

## Next Steps
1. On a workstation with internet + physical Android hardware, re-run `flutter_rust_bridge_codegen generate` and `dart run build_runner build --delete-conflicting-outputs`.
2. Re-run `flutter test --no-pub test/integration/calibration_flow_test.dart` to ensure the calibration/onboarding harness passes when sockets are allowed.
3. Build the debug APK (`flutter build apk --debug`), install it on each required device (Pixel + Samsung + alternate OEM), and execute every scenario while populating the tracker table.
4. Capture artifacts (screenshots, performance logs, exported debug JSON) and attach them to the Scenario Tracker + UAT Sign-Off report before closing Task 9.2.
